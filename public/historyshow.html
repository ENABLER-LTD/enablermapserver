<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistoryLoaction</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvtx-D_AVrB78-bTDzSaFuBLP5nRecsKM"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/mapmanage.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/cake.generic.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style1.css"/>

    <style>
        .mbox button {
            width: 100%;
            padding: 10px;
        }

    </style>
</head>
<body>
<div id="wrapper">

    <div id="map" style="display: block"></div>
    <div id="IndoorMap" style="display: none;flex-grow: 1"></div>

    <script>

        //Java　Hashmap 自分を定義する
        function HashMap() {
            this.map = {};
        }

        HashMap.prototype = {
            put: function (key, value) {
                this.map[key] = value;
            },
            get: function (key) {
                if (this.map.hasOwnProperty(key)) {
                    return this.map[key];
                }
                return null;
            },
            remove: function (key) {
                if (this.map.hasOwnProperty(key)) {
                    return delete this.map[key];
                }
                return false;
            },
            values: function () {
                var _values = new Array();
                for (var key in this.map) {
                    _values.push(this.map[key]);
                }
                return _values;
            },
            removeAll: function () {
                this.map = {};
            },
            keySet: function () {
                var _keys = [];
                for (var i in this.map) {
                    _keys.push(i);
                }
                return _keys;
            }
        };
        HashMap.prototype.constructor = HashMap;


        var dataArr;
        var resultArr;
        var map;
        var indoormap;
        var indoordetail = [];
        var test;
        let file_data = new HashMap();

        //屋内地図Map上に書く
        var getmapdetail = function (companycode) {
            $.ajax({
                type: 'GET',
                url: 'http://localhost:3000/getindoordetail/' + companycode,
                success: function (data) {
                    indoordetail = data;
                    for (let i = 0, len = indoordetail.length; i < len; i++) {
                        var templist = indoordetail[i].position.split("|");
                        var areaCoords = [];
                        for (let j = 0, len = templist.length; j < len; j++) {
                            var tempstring = {
                                lat: Number(templist[j].split(",")[0]),
                                lng: Number(templist[j].split(",")[1])
                            }
                            areaCoords.push(tempstring);
                        }
                        var areaTriangle = new google.maps.Polygon({
                            paths: areaCoords,
                            strokeColor: "#FF0000",
                            strokeOpacity: 0.8,
                            strokeWeight: 3,
                            fillColor: "#FF0000",
                            fillOpacity: 0.35,
                        });
                        areaTriangle.setMap(map);
                        areaTriangle.addListener("click", function () {
                            showindoormap(indoordetail[i].svgfile, indoordetail[i].keypoint);
                        });
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            })
        };

        //google map and leaflet map 初期化
        var initMap = function () {
            const Tokyo = {lat: 35.68, lng: 139.75};
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: Tokyo,
            });

            indoormap = L.map('IndoorMap', {
                center: [40.75, -74.2],
                zoom: 10
            });

            // var cookie_value = $.cookie("enabermap.uid");
            // var companycode = cookie_value.substring(0, 5);
            getmapdetail('00001');

            $.cookie('userlist', '9999908100100100016,9999908100100100017');
            $.cookie('target_time_min', '2020-11-05T04:38:45.244Z');
            $.cookie('target_time_max', '2020-12-01T04:43:22.744Z');
            $.cookie('speed', '10');
            var time = $.cookie("speed");
            var targetlist = $.cookie("userlist");
            var target_time_min = $.cookie("target_time_min");
            var target_time_max = $.cookie("target_time_max");
            var userlist = targetlist.split(',');
            for (let i = 0; i < userlist.length; i++) {
                let uid = userlist[i];
                resultArr = [];
                $.ajax({
                    type: 'GET',
                    async: false,
                    url: 'http://104.198.245.131:3000/historical/' + uid,
                    success: function (data) {
                        if (data != null) {
                            dataArr = data.split(/[(\r\n)\r\n]+/);
                            dataArr.pop();
                            for (let j = 0; j < dataArr.length; j++) {
                                dataArr[j] = JSON.parse(dataArr[j]);
                                if (dataArr[j].tim >= target_time_min && dataArr[j].tim <= target_time_max) {
                                    resultArr.push(dataArr[j]);
                                }
                            }
                            file_data.put(uid, resultArr);
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                })
            }
            alert("load log file success!")
            for (let i = 0; i < userlist.length; i++) {
                delay(0, file_data.get(userlist[i]), Number(time));
            }

        };
        initMap();

        var drawcurrentindoormap = function (filename, keypoint) {
            var keypoints = keypoint.split(",");
            //quit
            L.Control.quitpage = L.Control.extend({

                quitmain: function () {
                    document.getElementById("map").style.display = "block";
                    document.getElementById("IndoorMap").style.display = "none";
                    test.remove();
                    test1.remove();
                    test2.remove();
                },

                onAdd: function (map) {
                    var img = L.DomUtil.create('img');
                    img.src = '/icon/shut.png';
                    img.style.width = '50px'
                    L.DomEvent.addListener(img, 'click', this.quitmain, this);
                    return img;
                },

            });
            L.control.quitpage = function (opts) {
                return new L.Control.quitpage(opts);
            }

            var test1 = L.control.quitpage({position: 'topright'}).addTo(indoormap);

            //showmessage
            L.Control.showbox = L.Control.extend({

                onAdd: function (map) {
                    var divbox = L.DomUtil.create('div');
                    divbox.id = "info";
                    return divbox;
                },

            });
            L.control.showbox = function (opts) {
                return new L.Control.showbox(opts);
            }

            var test2 = L.control.showbox({position: 'bottomleft'}).addTo(indoormap);

            indoormap.on('mousemove', function (e) {
                document.getElementById('info').innerHTML = JSON.stringify(e.latlng);
            });

            var imageUrl = 'http://localhost/' + filename,
                imageBounds = [
                    [Number(keypoints[0]), Number(keypoints[1])],
                    [Number(keypoints[2]), Number(keypoints[3])]
                ];
            test = L.imageOverlay(imageUrl, imageBounds).addTo(indoormap);
            indoormap.fitBounds(imageBounds);
            indoormap.setZoom(22);

        }

        var showindoormap = function (filename, keypoint) {
            document.getElementById("map").style.display = "none";
            document.getElementById("IndoorMap").style.display = "block";
            drawcurrentindoormap(filename, keypoint);
        }

        var drawPoint = function (i, target, time) {
            if (i < target.length) {
                var lat = Number(target[i].lat);
                var lng = Number(target[i].lon);
                var marker = new google.maps.Marker({
                    position: {lat: lat, lng: lng},
                    map: map,
                });
                var lmarker = L.marker([lat, lng]).addTo(indoormap);
                i += 1;
                delay(i, target, time);
            } else {
                console.log("end");
            }
        }

        function delay(i, target, time) {
            setTimeout(function () {
                drawPoint(i, target, time);
            }, Number(time));
        }

    </script>
</div>

</body>
</html>
