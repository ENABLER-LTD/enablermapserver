<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistoryLoaction</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvtx-D_AVrB78-bTDzSaFuBLP5nRecsKM"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

    <link rel="stylesheet" type="text/css" href="/stylesheets/mapmanage.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/cake.generic.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style1.css"/>
    <style>
        .mbox button {
            width: 100%;
            padding: 10px;
        }
    </style>
</head>
<body>
<div id="wrapper">

    <div id="controler">

        <div id="log-file" class="ctl-box">
            <label>USER INFO</label>
            <table class="sim_data">
                UID
                <input id="user" type="text" style="font-size: 14px"/>
                時間
                <input id="time" type="text" value="all" style="font-size: 14px"/>
                <button id="getuser" style="padding: 0px" onclick="getuser()">検索</button>
                <tr class="back_g">
                    <th>UID</th>
                    <td class="2d_lpf_value" id="showuid"></td>
                </tr>
                <!--                <tr class="back_g">-->
                <!--                    <th style="width:60px;">端末ID</th>-->
                <!--                    <td class="device_id_value"></td>-->
                <!--                </tr>-->
                <tr class="back_g">
                    <th>表示時刻</th>
                    <td class="gpstime_value" id="showtime"></td>
                </tr>
                <tr class="back_g">
                    <th>緯度</th>
                    <td class="latitude_value" id="showlat"></td>
                </tr>
                <tr class="back_g">
                    <th>経度</th>
                    <td class="longitude_value" id="showlon"></td>
                </tr>
                <tr class="back_g">
                    <th>高度</th>
                    <td class="longitude_value" id="showalt"></td>
                </tr>
                <tr class="back_g">
                    <th>フロア</th>
                    <td class="longitude_value" id="showfloor"></td>
                </tr>
            </table>
        </div>

        <div id="player" class="ctl-box mbox">
            <label>Player</label>
            <select id="speed-select">
                <option value="1000">1x</option>
                <option value="500">2x</option>
                <option value="100">10x</option>
                <option value="50">20x</option>
            </select>
            <button id="player-stop" class="mbox">START</button>
        </div>

        <div id="map-control" class="ctl-box">
            <label>Map-control</label>
<!--            <div class="mbox">-->
<!--                <select id="map-mode">-->
<!--                    <option value="auto">Auto Zoom to Extent</option>-->
<!--                    <option value="center">Auto Marker Center</option>-->
<!--                </select>-->
<!--            </div>-->
            <div class="mbox">
                <button id="layer-clear">Marker Clear</button>
            </div>
        </div>

    </div>

    <div id="map"></div>
    <script>
        var dataArr;
        var targetArr = [];
        var drawlist = [];
        var drawtimer = null;
        var map;
        var i = 0;

        var initMap = function () {
            const Tokyo = {lat: 35.68, lng: 139.75};
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: Tokyo,
            });
        };
        initMap();

        var getuser = function () {
            const name = document.getElementById("user").value;
            $.ajax({
                timeout: 3000,
                type: 'GET',
                url: 'http://localhost:3000/historical/' + name,
                success: function (data) {
                    if (data != "") {
                        dataArr = data.split(/[(\r\n)\r\n]+/);
                        dataArr.pop();
                        for (let i = 0; i < dataArr.length; i++) {
                            dataArr[i] = JSON.parse(dataArr[i]);
                        }
                        // console.log(dataArr);
                        if (document.getElementById("time").value != "all") {
                            for (let i = 0; i < dataArr.length; i++) {
                                if (dataArr[i].time <= document.getElementById("time").value) {
                                    targetArr.push(dataArr[i]);
                                }

                            }
                            if (targetArr.length == 0) {
                                document.getElementById("showuid").innerText = "Not Found";
                                document.getElementById("showtime").innerText = "";
                                document.getElementById("showlon").innerText = "";
                                document.getElementById("showlat").innerText = "";
                                document.getElementById("showalt").innerText = "";
                            } else {
                                document.getElementById("showuid").innerText = dataArr[0].uid;
                                document.getElementById("showtime").innerText = dataArr[0].time;
                                document.getElementById("showlon").innerText = dataArr[0].lon;
                                document.getElementById("showlat").innerText = dataArr[0].lat;
                                document.getElementById("showlat").innerText = dataArr[0].alt;
                                targetArr = dataArr;
                                dataArr = [];
                            }
                        } else {
                            document.getElementById("showuid").innerText = dataArr[0].uid;
                            document.getElementById("showtime").innerText = dataArr[0].time;
                            document.getElementById("showlon").innerText = dataArr[0].lon;
                            document.getElementById("showlat").innerText = dataArr[0].lat;
                            document.getElementById("showlat").innerText = dataArr[0].alt;
                            targetArr = dataArr;
                            dataArr = [];
                        }
                    } else {
                        document.getElementById("showuid").innerText = "Not Found";
                    }
                },
                error: function (err) {
                    console.log(err);
                }
            })
        };

        var drawPoint = function () {
            var lat = Number(targetArr[i].lat);
            var lng = Number(targetArr[i].lon);
            var marker = new google.maps.Marker({
                position: {lat: lat, lng: lng},
                map: map,
            });
            drawlist.push(marker);
            document.getElementById("showuid").innerText = targetArr[i].uid;
            document.getElementById("showtime").innerText = targetArr[i].time;
            document.getElementById("showlon").innerText = targetArr[i].lon;
            document.getElementById("showlat").innerText = targetArr[i].lat;
            document.getElementById("showalt").innerText = targetArr[i].alt;
            map.setCenter({lat: Number(targetArr[i].lat), lng: Number(targetArr[i].lon)});
            if (i < targetArr.length) {
                i = i + 1;
            }
        }

        //draw one person position
        var drawMark = function () {
            var options = $("#speed-select option:selected");
            console.log(options.val());
            drawtimer = setInterval("drawPoint()", options.val());
        };


        document.getElementById('player-stop').addEventListener('click', function () {
            if (document.getElementById('player-stop').innerText == "START") {
                document.getElementById('player-stop').innerText = "STOP"
                drawMark();
            } else {
                document.getElementById('player-stop').innerText = "START"
                clearInterval(drawtimer);
            }
        });

        document.getElementById('layer-clear').addEventListener('click', function () {
            i = 0;
            clearInterval(drawtimer);
            for (var index in drawlist) {
                drawlist[index].setMap(null);
            }
            drawlist = null;
            document.getElementById("showuid").innerText = "";
            document.getElementById("showtime").innerText = "";
            document.getElementById("showlon").innerText = "";
            document.getElementById("showlat").innerText = "";
            document.getElementById("showalt").innerText = "";
        });

    </script>
</div>

</body>
</html>
